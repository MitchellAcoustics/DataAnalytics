---
title: "Data in and out"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(dplyr)
library(readxl)
library(haven)

knitr::opts_chunk$set(echo = FALSE)
```

## Importing and exporting data

This tutorial will cover the basics of importing and exporting data with R. It is largely based on [chapters 20-23](https://r4ds.hadley.nz/import) of the book "R for Data Science" by Hadley Wickham and Garrett Grolemund.

We will briefly review reading in data from text files formatted as CSV, TSV, and fixed-width files. We will also cover reading in data from Excel files, other statistical packages (SPSS, Stata, and SAS), databases, and hierarchical data formats.

The ability to import a wide range of data formats is one of R's strengths and a very useful skill to have as a data scientist. 

When covering the various file format that we can import data from, we will also discuss the various options that are available to export the data, which can be very useful when sharing data with others.

## Review on loading text files

In the tutorial entitled "The Basics of R", which relied on [chapter 7 of R for data science](https://r4ds.hadley.nz/data-import), we talked about importing data from text files. Below is a brief review.


### Loading a csv file

As before, all the data files are stored in the `./data` folder. 
First, you will find there a csv (comma-separated value) file that you will be able to read using the `read.csv()` function, the file name is "bsa2021_healthcare_equalities_recoded.csv". Load it.


```{r readcsv, exercise=TRUE}

bsa <- ____

head(bsa)
```

```{r readcsv-hint}
# the function to use is read.csv
#Then you can use the path to the file inside this function

```

```{r readcsv-solution}

bsa <- read.csv("./data/bsa2021_healthcare_equalities_recoded.csv")

head(bsa)

```

Alternatively, you can also use the `read_csv()` function from the `readr` package. This function is faster than `read.csv()`, and does not convert strings to factors by default. It also stores the data in a tibble, which is a modified version of a data frame. Most of the time, you can use a tibble as if it were a data frame, but there are times when using a normal dataframe is the better choice. I use read_csv() myself most of the time, but it is useful for you to know that a difference exists.

### Loading a tab separated file

Tab separated files are very common and, like CSV files, they are simple text files. But instead of a comma, they use tabulation as a separator.
In the same `./data` folder, there is a file named "bsa2021_healthcare_equalities_recoded.tab". Load it.

```{r readtab, exercise=TRUE}

bsa <- ____

head(bsa)
```

```{r readtab-hint}
# the function to use is read.delim
#Then you can use the path to the file inside this function

```

```{r readtab-solution}

bsa <- read.delim("./data/bsa2021_healthcare_equalities_recoded.tab")

head(bsa)

```


## Working with data from Excel

Excel files are probably the most common type of files that you will encounter in your work, because Excel is so widely used. When you work with external collaborators, it is very likely that some of the data they will give you will be in Excel spreadsheets. And when you are sharing data back with internal and external stakeholders, it is quite likely that sharing Excel spreadsheets is the best way to ensure that they can easily access the data.

### Loading an excel file

Excel files are a bit more complicated than text files. While there are ways to load excel files, for these to work, your excel spreadsheet needs to be reasonably well formatted (i.e. it is a series of observation in rows with different variables in columns).
We can use the `readxl` package to load functions that will allow us to read excel files.

```{r readxl, exercise=TRUE}
library(readxl)
bsa <- ____

head(bsa)
```

```{r readxl-hint}
# the function to use is read_xlsx()
#Then you can use the path to the file inside this function

```

```{r readxl-solution}

bsa <- read_xlsx("./data/bsa2021_healthcare_equalities_recoded.xlsx")

head(bsa)

```


### Skipping Rows and Handling Headers

Some files contain metadata at the top. Use `skip` to ignore rows. Use `col_names` to specify if the file has a header row.

```{r, echo=TRUE}
# Skip the first 2 rows
data <- read_excel("./data/bsa2021_healthcare_equalities_recoded.xlsx", skip = 2)
head(data)
```

### Exercise: Skip Rows
Read the 'bsa2021_healthcare_equalities_recoded.xlsx' file and skip the first 3 rows:

```{r skipRow, exercise = TRUE}
data <- read_excel(____, skip = ___)
head(data)
```


Combining Multiple Sheets from Excel Files

### Reading Multiple Sheets
Use the `sheet` argument to specify which sheet to read. You can specify either the name of the sheet, or the index of the sheet.

```{r, echo=TRUE}
# Read a specific sheet
data <- read_excel("./data/bsa2021_healthcare_equalities_recoded_multisheet.xlsx", sheet = 2)
data
```

### Read a Specific Sheet
Read the sheet `"secondSheet"` from the file `bsa2021_healthcare_equalities_recoded_multisheet.xlsx`:

```{r secondSheet, exercise = TRUE}
# Read a specific sheet
data <- read_excel(____, sheet = ___)

data
```

### Reading Part of a Sheet

When spreadsheets contain extraneous information, use the `range` argument to specify the part of the sheet you want to import.

The following file includes metadata above and below the data. The data starts at cell `A5` and ends at `F15`.
Use the `range` argument to read only the data portion (cells `A5:F15`) from the `bsa2021_healthcare_equalities_recoded_range.xlsx` file (remember, the data is in `./data`):

```{r range, exercise = TRUE}
bsa <- read_excel(____, range = "___")
bsa
```


## Combining Multiple Sheets from Excel Files

### Reading Multiple Sheets
Use the `sheet` argument to specify which sheet to read.
The file "bsa2021_partial_multisheet2.xlsx" contains three sheets: firstSheet, secondSheet, and thirdSheet. Each of these contains 100 records from the bsa data we have been working with. Load all the sheets in different objects and combine them using `bind_rows()`.

```{r bindrows, exercise = TRUE}
firstSheet <- read_excel(___, sheet = ___)
secondSheet <- read_excel(___, sheet = ___)
thirdSheet <- read_excel(___, sheet = ___)

data <- ____(____, ____, ____)

summary(data)
```


## Working with data from other statistical packages

There are several R packages that allow you to read data from other statistical packages. 
The two most commonly used ones are `haven` and `foreign`. 
The `haven` package is part of the tidyverse and therefore interfaces nicely with other tidyverse packages. 
The `foreign` package is older and has been around for a long time. 
It is not part of the tidyverse, but it is still widely used.
While this tutorial focuses on using the `haven` package, it is useful to keep in mind that the foreign package exists.



### SPSS

The `haven` package provides functions to read SPSS files. The `read_sav()` function reads SPSS files.
In the `./data` folder, there is a file named "bsa2021_healthcare_equalities_open.sav". Load it.

```{r readspss, exercise=TRUE}
library(haven)
bsa <- ____

head(bsa)
```

```{r readspss-hint}
# The function to use is read_sav
# Then you can use the path to the file inside this function

```

```{r readspss-solution}

bsa <- read_sav("./data/bsa2021_healthcare_equalities_open.sav")

head(bsa)

```

One thing you can notice when using `head()` is that the data is numerically coded (for example, 1 for men, 2 for women) instead of being stored in a more human readable format. The version of the BSA that we have been using in previous tutorial had already been recoded to make it easier to work with. It is important not to underestimate how much data cleaning and preparation goes into any analysis, even when the input data is already clean (and you data cannot get much cleaner than the UK data service data).


### Stata

The `read_dta()` function reads Stata files.

```{r readstata, exercise=TRUE}
bsa <- ____

head(bsa)

```

```{r readstata-hint}
# The function to use is read_dta
# Then you can use the path to the file inside this function

```

```{r readstata-solution}

bsa <- read_dta("./data/bsa2021_healthcare_equalities_open.dta")

head(bsa)

```

### SAS

The `read_sas()` function reads SAS files. I borrowed data from [The Principles of Econometrics](http://www.principlesofeconometrics.com). The dataset is called `london.sas7bdat` and you can find it in the `./data` folder. This data comes from the British Family Expenditure survey (1980-1982). The data is a sample of households in London. The variables are: wfood	=	budget share for food expenditure, wcloth	=	budget share for clothing expenditure, totexp	=	total household expenditure in UK pounds sterling per week (nearest 10 pounds), age	=	age of household head, nk	=	number of children. All the British Family Expenditure surveys from 1961 are available on the [UK data service](https://beta.ukdataservice.ac.uk/datacatalogue/series/series?id=200016#!/access-data).


```{r readsas, exercise=TRUE}

london <- ____

head(london)

```

```{r readsas-hint}
# The function to use is read_sas
# Then you can use the path to the file inside this function

```

```{r readsas-solution}

london <- read_sas("./data/london.sas7bdat")

head(london)

```


## Working with data from databases



## Working with data in hierarchical data formats

